---
- name: Créer Virtual Server avec Pool et Nodes
  hosts: f5
  gather_facts: no
  collections:
    - f5networks.f5_modules

  vars_files:
    - ../group_vars/f5.yml

  vars_prompt:
    - name: vs_name
      prompt: "Nom du Virtual Server"
      private: no

    - name: vs_destination
      prompt: "Adresse IP du Virtual Server"
      private: no

    - name: vs_port
      prompt: "Port du Virtual Server"
      private: no
      default: "80"

    - name: pool_name
      prompt: "Nom du Pool"
      private: no

    - name: pool_monitor
      prompt: "Monitor du Pool"
      private: no
      default: "http"

    - name: node1_name
      prompt: "Nom du Node 1"
      private: no

    - name: node1_ip
      prompt: "IP du Node 1"
      private: no

    - name: node1_port
      prompt: "Port du Node 1"
      private: no
      default: "80"

    - name: node2_name
      prompt: "Nom du Node 2 (laisser vide si un seul node)"
      private: no
      default: ""

    - name: node2_ip
      prompt: "IP du Node 2 (laisser vide si un seul node)"
      private: no
      default: ""

    - name: node2_port
      prompt: "Port du Node 2"
      private: no
      default: "80"

  tasks:
    - name: "Créer le Node 1: {{ node1_name }}"
      bigip_node:
        provider: "{{ f5_provider }}"
        name: "{{ node1_name }}"
        host: "{{ node1_ip }}"
        state: present
      delegate_to: localhost

    - name: "Créer le Node 2: {{ node2_name }}"
      bigip_node:
        provider: "{{ f5_provider }}"
        name: "{{ node2_name }}"
        host: "{{ node2_ip }}"
        state: present
      delegate_to: localhost
      when: node2_name != "" and node2_ip != ""

    - name: "Créer le Pool {{ pool_name }}"
      bigip_pool:
        provider: "{{ f5_provider }}"
        name: "{{ pool_name }}"
        lb_method: round-robin
        monitors:
          - "/Common/{{ pool_monitor }}"
        state: present
      delegate_to: localhost

    - name: "Ajouter Node 1 au Pool"
      bigip_pool_member:
        provider: "{{ f5_provider }}"
        pool: "{{ pool_name }}"
        name: "{{ node1_name }}"
        host: "{{ node1_ip }}"
        port: "{{ node1_port }}"
        state: present
      delegate_to: localhost

    - name: "Ajouter Node 2 au Pool"
      bigip_pool_member:
        provider: "{{ f5_provider }}"
        pool: "{{ pool_name }}"
        name: "{{ node2_name }}"
        host: "{{ node2_ip }}"
        port: "{{ node2_port }}"
        state: present
      delegate_to: localhost
      when: node2_name != "" and node2_ip != ""

    - name: "Créer le Virtual Server {{ vs_name }}"
      bigip_virtual_server:
        provider: "{{ f5_provider }}"
        name: "{{ vs_name }}"
        destination: "{{ vs_destination }}"
        port: "{{ vs_port }}"
        pool: "{{ pool_name }}"
        snat: automap
        profiles:
          - http
          - tcp
        state: present
      delegate_to: localhost

    - name: "Résumé de la configuration"
      debug:
        msg:
          - "=== Configuration créée avec succès ==="
          - "Virtual Server: {{ vs_name }} ({{ vs_destination }}:{{ vs_port }})"
          - "Pool: {{ pool_name }} (monitor: {{ pool_monitor }})"
          - "Node 1: {{ node1_name }} ({{ node1_ip }}:{{ node1_port }})"
          - "Node 2: {{ node2_name | default('Non configuré') }} {{ '(' + node2_ip + ':' + node2_port + ')' if node2_ip != '' else '' }}"
