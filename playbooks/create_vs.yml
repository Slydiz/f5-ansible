---
- name: VS
  hosts: f5
  gather_facts: no
  collections:
    - f5networks.f5_modules

  vars_files:
    - ../group_vars/f5.yml

  vars:
    # Personnaliser selon vos besoins
    vs_name: "vs-test"
    vs_destination: "10.69.238.220"
    vs_port: 80
    vs_traffic_group: "traffic-group-2"  # ou traffic-group-2 (sans /Common/)

  tasks:
    - name: "Cr√©er VS {{ vs_name }}"
      bigip_virtual_server:
        provider: "{{ f5_provider }}"
        name: "{{ vs_name }}"
        destination: "{{ vs_destination }}"
        port: "{{ vs_port }}"
        description: "VS on {{ vs_traffic_group }}"
        snat: automap
        partition: Common
        state: present
      delegate_to: localhost

    - name: "Assigner {{ vs_name }} au Traffic Group {{ vs_traffic_group }}"
      uri:
        url: "https://{{ ansible_host }}/mgmt/tm/ltm/virtual/~Common~{{ vs_name }}"
        method: PATCH
        user: "{{ ansible_user }}"
        password: "{{ ansible_password }}"
        body:
          trafficGroup: "/Common/{{ vs_traffic_group }}"
        body_format: json
        validate_certs: no
        status_code: 200
      delegate_to: localhost
      when: vs_traffic_group is defined

    - name: "Sauvegarder la configuration"
      bigip_command:
        provider: "{{ f5_provider }}"
        commands:
          - "save sys config"
      delegate_to: localhost
      when: vs_traffic_group is defined